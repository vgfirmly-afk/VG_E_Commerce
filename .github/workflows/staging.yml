name: PR â†’ Simple Staging (matrix)

# Trigger on PRs (opened, reopened, synchronize)
on:
  pull_request:
    types: [opened, reopened, synchronize]

env:
  NODE_VERSION: 20
  WF_DOMAIN_ROOT: "vg-firmly.workers.dev"
  HEALTH_PATH: "/_/health"
  PUBLISH_SLEEP_SECONDS: 5

permissions:
  contents: read

jobs:
  staging-matrix:
    name: Publish & test ${{ matrix.prod_name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - dir: backend/Auth_Worker
            prod_name: w2-auth-worker
          - dir: backend/Catalog_worker
            prod_name: w2-catalog-worker
          - dir: backend/Cart_Worker
            prod_name: w2-cart-worker
          - dir: backend/Pricing_Worker
            prod_name: w2-pricing-worker
          - dir: backend/Invertory_Worker
            prod_name: w2-inventory-worker
          - dir: backend/Payment_worker
            prod_name: w2-payment-worker
          - dir: backend/Checkout_Worker
            prod_name: w2-checkout-worker
          - dir: backend/Fullfilment_Worker
            prod_name: w2-fullfillment-worker

    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 50

      - name: Set up Node.js (compatible with Wrangler v4)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install root dependencies
        run: npm ci

      # Install a pinned Wrangler v4 to avoid CLI surprises
      - name: Install Wrangler CLI (pinned)
        run: npm install -g wrangler@4.49.0

      - name: Publish to staging (wrangler deploy)
        # NOTE: use CLOUDFLARE_API_TOKEN (preferred) mapped from your secret
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN_STAGING }}
        run: |
          echo "Deploying ${GITHUB_REPOSITORY}:${GITHUB_SHA} -> staging for ${matrix.prod_name} (dir=${{ matrix.dir }})"
          # Use --cwd so wrangler runs in the worker's folder; --env staging selects your env in wrangler.toml
          # Using --config is optional if wrangler.toml is at the project root or accessible from cwd.
          wrangler deploy --env staging --cwd "${{ matrix.dir }}"

      - name: Wait for staging propagation
        run: sleep ${{ env.PUBLISH_SLEEP_SECONDS }}

      - name: Run unit tests (workspace)
        run: npm --workspace "${{ matrix.dir }}" run test

      - name: Run coverage (workspace)
        run: npm --workspace "${{ matrix.dir }}" run coverage

      - name: Health check staging URL
        run: |
          URL="https://stageenv-${{ matrix.prod_name }}.${{ env.WF_DOMAIN_ROOT }}${{ env.HEALTH_PATH }}"
          echo "Checking $URL"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$URL" || echo "000")
          echo "HTTP $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Health check failed: $HTTP_CODE"
            exit 1
          fi
          echo "Health OK"

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.prod_name }}
          path: |
            ${{ matrix.dir }}/coverage
            coverage
            ./coverage
