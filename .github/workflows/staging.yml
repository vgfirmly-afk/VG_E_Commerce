name: PR → Staging (matrix)

# Trigger on PRs (opened, reopened, synchronize)
on:
  pull_request:
    types: [opened, reopened, synchronize]

env:
  NODE_VERSION: 20
  WF_DOMAIN_ROOT: "vg-firmly.workers.dev"
  HEALTH_PATH: "/_/health"
  PUBLISH_SLEEP_SECONDS: 5

permissions:
  contents: read

jobs:
  staging-matrix: 
    name: Publish & test ${{ matrix.prod_name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - dir: backend/Auth_Worker
            prod_name: w2-auth-worker
          - dir: backend/Catalog_worker
            prod_name: w2-catalog-worker
          - dir: backend/Cart_Worker
            prod_name: w2-cart-worker
          - dir: backend/Pricing_Worker
            prod_name: w2-pricing-worker
          - dir: backend/Invertory_Worker
            prod_name: w2-inventory-worker
          - dir: backend/Payment_worker
            prod_name: w2-payment-worker
          - dir: backend/Checkout_Worker
            prod_name: w2-checkout-worker
          - dir: backend/Fullfilment_Worker
            prod_name: w2-fullfillment-worker

    environment: staging
    timeout-minutes: 40
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 50
  
      - name: Set up Node.js (compatible with Wrangler v4)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: |
          npm ci
          npm install -g wrangler@4.49.0

      - name: Verify Cloudflare API token is set
        run: |
          if [ -z "${{ secrets.CF_API_TOKEN_STAGING }}" ]; then
            echo "::error::CF_API_TOKEN_STAGING secret is not set"
            echo ""
            echo "To fix this:"
            echo "1. Go to GitHub Settings > Environments > staging > Secrets"
            echo "   OR GitHub Settings > Secrets and variables > Actions"
            echo "2. Add a secret named: CF_API_TOKEN_STAGING"
            echo "3. Value should be your Cloudflare API token"
            echo ""
            echo "Token requirements:"
            echo "- Create at: https://dash.cloudflare.com/profile/api-tokens"
            echo "- Permissions needed: Workers:Edit, Account:Read, D1:Edit, KV:Edit, R2:Edit"
            echo "- Use 'Edit Cloudflare Workers' template or create custom token"
            exit 1
          fi
          echo "✓ Token secret is configured"

      - name: Log deployment info
        run: |
          echo "Deploying ${{ github.repository }}:${{ github.sha }} -> staging for ${{ matrix.prod_name }}"
          echo "Working directory: ${{ matrix.dir }}"
          # Verify token is accessible (without exposing it)
          if [ -n "${{ secrets.CF_API_TOKEN_STAGING }}" ]; then
            echo "✓ Token is accessible (length: $(echo -n '${{ secrets.CF_API_TOKEN_STAGING }}' | wc -c))"
          else
            echo "::error::Token is empty or not accessible"
            exit 1
          fi

      - name: Test and select Cloudflare API token
        id: cf_token_check
        run: |
          # Test staging token first
          if [ -n "${{ secrets.CF_API_TOKEN_STAGING }}" ]; then
            echo "Testing CF_API_TOKEN_STAGING..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X GET "https://api.cloudflare.com/client/v4/user/tokens/verify" \
              -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN_STAGING }}" \
              -H "Content-Type: application/json" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "use_staging=true" >> $GITHUB_OUTPUT
              echo "✓ CF_API_TOKEN_STAGING is valid"
              exit 0
            else
              echo "⚠ CF_API_TOKEN_STAGING exists but is invalid (HTTP $HTTP_CODE)"
              echo "  Possible issues:"
              echo "  - Token is expired or revoked"
              echo "  - Token has insufficient permissions"
              echo "  - Token value is incorrect"
            fi
          else
            echo "⚠ CF_API_TOKEN_STAGING is not set in staging environment"
          fi
          
          # Fallback to production token
          if [ -n "${{ secrets.CF_API_TOKEN_PROD }}" ]; then
            echo "Testing CF_API_TOKEN_PROD as fallback..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X GET "https://api.cloudflare.com/client/v4/user/tokens/verify" \
              -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN_PROD }}" \
              -H "Content-Type: application/json" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "use_staging=false" >> $GITHUB_OUTPUT
              echo "⚠ Using CF_API_TOKEN_PROD (staging token invalid/missing)"
              echo "::warning::Using production token for staging. Set up CF_API_TOKEN_STAGING in the 'staging' environment."
              exit 0
            else
              echo "::error::CF_API_TOKEN_PROD is also invalid (HTTP $HTTP_CODE)"
            fi
          fi
          
          echo "::error::No valid Cloudflare API token found!"
          echo ""
          echo "SOLUTION:"
          echo "1. Go to: Repository Settings > Environments > staging > Secrets"
          echo "2. Add secret: CF_API_TOKEN_STAGING"
          echo "3. Use the SAME token value as CF_API_TOKEN_PROD (or create new token)"
          echo "4. Token needs: Account:Read, Workers:Edit, D1:Edit, KV:Edit, R2:Edit"
          echo "5. Create token: https://dash.cloudflare.com/profile/api-tokens"
          exit 1

      - name: Deploy to staging using Wrangler (with staging token)
        if: steps.cf_token_check.outputs.use_staging == 'true'
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN_STAGING }}
        run: |
          cd "${{ matrix.dir }}"
          echo "Deploying from: $(pwd)"
          echo "Using: CF_API_TOKEN_STAGING"
          wrangler deploy --env staging

      - name: Deploy to staging using Wrangler (with prod token fallback)
        if: steps.cf_token_check.outputs.use_staging != 'true'
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN_PROD }}
        run: |
          cd "${{ matrix.dir }}"
          echo "Deploying from: $(pwd)"
          echo "Using: CF_API_TOKEN_PROD (fallback)"
          wrangler deploy --env staging

      - name: Wait for staging propagation
        run: sleep ${{ env.PUBLISH_SLEEP_SECONDS }}

      - name: Run unit tests (workspace)
        run: npm --workspace "${{ matrix.dir }}" run test

      - name: Run coverage (workspace)
        run: npm --workspace "${{ matrix.dir }}" run coverage

      - name: Health check staging URL
        run: |
          URL="https://stageenv-${{ matrix.prod_name }}.${{ env.WF_DOMAIN_ROOT }}${{ env.HEALTH_PATH }}"
          echo "Checking $URL"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$URL" || echo "000")
          echo "HTTP $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Health check failed: $HTTP_CODE"
            exit 1
          fi
          echo "Health OK"

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.prod_name }}
          path: |
            ${{ matrix.dir }}/coverage
            coverage
            ./coverage
