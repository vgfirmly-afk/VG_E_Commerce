name: Deploy to Staging

on:
  push:
    branches:
      - Features/cd5
      - features/cd5
      - main
      - develop
    # Only trigger if backend files change (optional - remove paths to trigger on any change)
    paths:
      - 'backend/**'
      - '.github/workflows/staging-deploy.yml'
  pull_request:
    branches:
      - Features/cd5
      - features/cd5
      - main
      - develop
    paths:
      - 'backend/**'
      - '.github/workflows/staging-deploy.yml'
  workflow_dispatch:

env:
  NODE_VERSION: 20
  WRANGLER_VERSION: 4.49.0

permissions:
  contents: read

jobs:
  deploy-staging:
    name: Deploy ${{ matrix.worker_name }} to Staging
    runs-on: ubuntu-latest
    environment: staging
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - worker_dir: backend/Auth_Worker
            worker_name: w2-auth-worker
          - worker_dir: backend/Cart_Worker
            worker_name: w2-cart-worker
          - worker_dir: backend/Catalog_worker
            worker_name: w2-catalog-worker
          - worker_dir: backend/Checkout_Worker
            worker_name: w2-checkout-worker
          - worker_dir: backend/Fullfilment_Worker
            worker_name: w2-fullfillment-worker
          - worker_dir: backend/Invertory_Worker
            worker_name: w2-inventory-worker
          - worker_dir: backend/Payment_worker
            worker_name: w2-payment-worker
          - worker_dir: backend/Pricing_Worker
            worker_name: w2-pricing-worker

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Debug workflow trigger
        run: |
          echo "üîç Workflow Debug Information:"
          echo "Branch: ${{ github.ref }}"
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Changed files:"
          git diff --name-only HEAD~1 HEAD || echo "Unable to determine changed files"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Wrangler CLI
        run: npm install -g wrangler@${{ env.WRANGLER_VERSION }}

      - name: Install dependencies
        run: |
          cd ${{ matrix.worker_dir }}
          npm ci

      - name: Verify Cloudflare credentials
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN_STAGING }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          echo "üîç Verifying Cloudflare credentials..."
          
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "::error::CF_API_TOKEN_STAGING secret is not set"
            exit 1
          fi
          
          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "::error::CF_ACCOUNT_ID secret is not set"
            exit 1
          fi
          
          echo "‚úì Credentials are set"
          
          # Verify token with Cloudflare API
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X GET "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/tokens/verify" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json")
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Token verification failed (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          echo "‚úì Token is valid"

      - name: Deploy to Cloudflare Workers (Staging)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN_STAGING }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          cd ${{ matrix.worker_dir }}
          echo "üöÄ Deploying ${{ matrix.worker_name }} to staging environment..."
          wrangler deploy --env staging
          echo "‚úÖ Deployment completed successfully"

      - name: Wait for deployment propagation
        run: sleep 5

      - name: Run tests
        continue-on-error: true
        run: |
          cd ${{ matrix.worker_dir }}
          if npm run test 2>/dev/null; then
            echo "‚úÖ Tests passed"
          else
            echo "‚ö†Ô∏è  Tests failed or test script not found, continuing..."
          fi

      - name: Health check (if available)
        continue-on-error: true
        run: |
          WORKER_URL="https://stageenv-${{ matrix.worker_name }}.vg-firmly.workers.dev/_/health"
          echo "Checking health endpoint: $WORKER_URL"
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$WORKER_URL" || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Health check passed (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è  Health check returned HTTP $HTTP_CODE (this may be expected if health endpoint doesn't exist)"
          fi

      - name: Upload coverage (if available)
        if: always()
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: coverage-${{ matrix.worker_name }}
          path: ${{ matrix.worker_dir }}/coverage
          retention-days: 7

