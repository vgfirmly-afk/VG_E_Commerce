name: Deploy to Staging

on:
  push:
    branches:
      - Features/cd5
      - features/cd5
      - main
      - develop
    paths:
      - 'backend/**'
      - '.github/workflows/staging-deploy.yml'
  pull_request:
    branches:
      - Features/cd5
      - features/cd5
      - main
      - develop
    paths:
      - 'backend/**'
      - '.github/workflows/staging-deploy.yml'
  workflow_dispatch:

env:
  NODE_VERSION: 20
  WRANGLER_VERSION: 4.49.0

permissions:
  contents: read

jobs:
  deploy-staging:
    name: Deploy ${{ matrix.worker_name }} to Staging
    runs-on: ubuntu-latest
    environment: staging
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - worker_dir: backend/Auth_Worker
            worker_name: w2-auth-worker
          - worker_dir: backend/Cart_Worker
            worker_name: w2-cart-worker
          - worker_dir: backend/Catalog_worker
            worker_name: w2-catalog-worker
          - worker_dir: backend/Checkout_Worker
            worker_name: w2-checkout-worker
          - worker_dir: backend/Fullfilment_Worker
            worker_name: w2-fullfillment-worker
          - worker_dir: backend/Invertory_Worker
            worker_name: w2-inventory-worker
          - worker_dir: backend/Payment_worker
            worker_name: w2-payment-worker
          - worker_dir: backend/Pricing_Worker
            worker_name: w2-pricing-worker

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ github.event_name == 'pull_request' && 0 || 2 }}

      - name: Check if worker changed
        id: check_changes
        run: | 
          CHANGED=false
          WORKER_DIR="${{ matrix.worker_dir }}"
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            CHANGED=true
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.sha }}"
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR "$BASE_SHA" "$HEAD_SHA" 2>/dev/null || echo "")
          else
            BEFORE_SHA="${{ github.event.before }}"
            AFTER_SHA="${{ github.sha }}"
            
            if [ -n "$BEFORE_SHA" ] && [ "$BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
              CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR "$BEFORE_SHA" "$AFTER_SHA" 2>/dev/null || echo "")
            else
              CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR HEAD~1 HEAD 2>/dev/null || echo "")
            fi
          fi
          
          # Check if any backend files changed (exclude .github, coverage, and node_modules)
          BACKEND_CHANGED=$(echo "$CHANGED_FILES" | grep -E "^backend/" | grep -v "^\.github/" | grep -v "/coverage/" | grep -v "/node_modules/" || echo "")
          
          # Only check worker if backend files actually changed
          if [ -n "$BACKEND_CHANGED" ]; then
            # Check if files in this specific worker directory changed (exclude coverage and node_modules)
            # Escape the directory path and use exact prefix match
            WORKER_PATTERN="^$(echo "$WORKER_DIR" | sed 's/[.[\*^$()+?{|]/\\&/g')/"
            WORKER_CHANGED=$(echo "$CHANGED_FILES" | grep -E "$WORKER_PATTERN" | grep -v "/coverage/" | grep -v "/node_modules/" || echo "")
            
            if [ -n "$WORKER_CHANGED" ]; then
              CHANGED=true
            fi
          fi
          
          if [ "$CHANGED" = "true" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "✓ ${{ matrix.worker_name }} has changes - will deploy"
            echo "Changed files in $WORKER_DIR:"
            echo "$WORKER_CHANGED" | sed 's/^/  - /'
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "✗ ${{ matrix.worker_name }} has no changes - skipping"
          fi

      - name: Set up Node.js
        if: steps.check_changes.outputs.changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Wrangler CLI
        if: steps.check_changes.outputs.changed == 'true'
        run: npm install -g wrangler@${{ env.WRANGLER_VERSION }}

      - name: Install root dependencies (skip scripts)
        if: steps.check_changes.outputs.changed == 'true'
        env:
          HUSKY: 0
        run: |
          npm ci --ignore-scripts || echo "Root dependencies install skipped or failed"

      - name: Install worker dependencies
        if: steps.check_changes.outputs.changed == 'true'
        env:
          HUSKY: 0
        run: |
          cd ${{ matrix.worker_dir }}
          npm ci --ignore-scripts

      - name: Deploy to Cloudflare Workers (Staging)
        if: steps.check_changes.outputs.changed == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN_STAGING }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          cd ${{ matrix.worker_dir }}
          wrangler deploy --env staging

      - name: Wait for deployment propagation
        if: steps.check_changes.outputs.changed == 'true'
        run: sleep 5

      - name: Run tests
        if: steps.check_changes.outputs.changed == 'true'
        continue-on-error: true
        run: |
          cd ${{ matrix.worker_dir }}
          npm run test || true

      - name: Health check
        if: steps.check_changes.outputs.changed == 'true'
        continue-on-error: true
        run: |
          curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://stageenv-${{ matrix.worker_name }}.vg-firmly.workers.dev/_/health" || true

      - name: Upload coverage (if available)
        if: steps.check_changes.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: coverage-${{ matrix.worker_name }}
          path: ${{ matrix.worker_dir }}/coverage
          retention-days: 7

 