import ts from 'typescript';
import { IMPORT_MODIFIERS, IMPORT_STAR } from '../../../constants.js';
import { importVisitor as visit } from '../index.js';
const supportsJSDocImportTag = 'isJSDocImportTag' in ts;
const getImportSpecifiers = (node) => {
    const imports = [];
    function visit(node) {
        if (ts.isImportTypeNode(node)) {
            const importClause = node.argument;
            if (ts.isLiteralTypeNode(importClause) && ts.isStringLiteral(importClause.literal)) {
                const identifier = node.qualifier && ts.isIdentifier(node.qualifier) ? String(node.qualifier.escapedText) : 'default';
                imports.push({
                    specifier: importClause.literal.text,
                    identifier,
                    pos: node.qualifier?.getStart() ?? importClause.literal.pos,
                    modifiers: IMPORT_MODIFIERS.NONE,
                });
            }
        }
        if (supportsJSDocImportTag && ts.isJSDocImportTag(node) && ts.isStringLiteralLike(node.moduleSpecifier)) {
            if (node.importClause?.namedBindings && ts.isNamedImportBindings(node.importClause.namedBindings)) {
                const bindings = node.importClause.namedBindings;
                if (ts.isNamespaceImport(bindings)) {
                    imports.push({
                        specifier: node.moduleSpecifier.text,
                        identifier: IMPORT_STAR,
                        pos: bindings.name.getStart(),
                        modifiers: IMPORT_MODIFIERS.TYPE_ONLY,
                    });
                }
                else {
                    for (const element of bindings.elements) {
                        imports.push({
                            specifier: node.moduleSpecifier.text,
                            identifier: String((element.propertyName ?? element.name).escapedText),
                            pos: element.name.getStart(),
                            modifiers: IMPORT_MODIFIERS.TYPE_ONLY,
                        });
                    }
                }
            }
        }
        ts.forEachChild(node, visit);
    }
    visit(node);
    return imports;
};
export default visit(() => true, node => {
    if ('jsDoc' in node && node.jsDoc) {
        const jsDoc = node.jsDoc;
        if (jsDoc.length > 0 && jsDoc[0].parent.parent === node.parent) {
            return jsDoc.flatMap(jsDoc => (jsDoc.tags ?? []).flatMap(getImportSpecifiers));
        }
    }
    return [];
});
